<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Tree Health Monitoring System</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* Header Bar */
        .header-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .header-title {
            font-size: 24px;
            font-weight: 600;
            margin-right: 20px;
        }
        
        .header-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* Legend Panel */
        .legend-panel {
            position: absolute;
            top: 70px;
            right: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 300px;
            overflow: hidden;
        }
        
        .legend-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            font-size: 16px;
        }
        
        .legend-content {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .legend-section {
            margin-bottom: 20px;
        }
        
        .legend-section:last-child {
            margin-bottom: 0;
        }
        
        .legend-section-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            display: flex;
            align-items: center;
        }
        
        .legend-toggle {
            margin-left: auto;
            cursor: pointer;
        }
        
        .legend-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #666;
            flex-shrink: 0;
        }
        
        .legend-label {
            color: #555;
        }
        
        /* Base Map Selector */
        .basemap-selector {
            position: absolute;
            top: 70px;
            left: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            padding: 10px;
        }
        
        .basemap-selector select {
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            background: white;
            color: #333;
            outline: none;
        }
        
        .basemap-selector select:hover {
            border-color: #764ba2;
        }
        
        /* Map Controls */
        .leaflet-control-zoom {
            margin-top: 70px !important;
        }
        
        /* Popup Styling */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.3);
        }
        
        .leaflet-popup-content {
            margin: 15px;
            font-size: 13px;
        }
        
        .leaflet-popup-content table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .leaflet-popup-content td {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        
        /* Scrollbar Styling */
        .legend-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .legend-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .legend-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .legend-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header-title {
                font-size: 18px;
            }
            
            .header-subtitle {
                display: none;
            }
            
            .legend-panel {
                max-width: 250px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header-bar">
        <div class="header-title">ðŸŒ³ Tree Health Monitoring System</div>
        <div class="header-subtitle">Real-time vegetation health analysis</div>
    </div>
    
    <!-- Map Container -->
    <div id="map"></div>
    
    <!-- Base Map Selector -->
    <div class="basemap-selector">
        <select id="basemap-select">
            <option value="dark">Dark Map</option>
            <option value="streets">Street Map</option>
            <option value="satellite">Satellite</option>
            <option value="terrain">Terrain</option>
        </select>
    </div>
    
    <!-- Legend Panel -->
    <div class="legend-panel">
        <div class="legend-header">Map Layers & Legend</div>
        <div class="legend-content">
            <div class="legend-section">
                <div class="legend-section-title">
                    Health Categories
                    <div class="legend-toggle">
                        <input type="checkbox" id="toggle-health" checked>
                    </div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(6,92,0,1.0);"></div>
                    <div class="legend-label">Healthy (0.854 - 0.914)</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(255,187,0,1.0);"></div>
                    <div class="legend-label">Moderate (0.808 - 0.854)</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(254,47,47,1.0);"></div>
                    <div class="legend-label">Unhealthy (0.635 - 0.808)</div>
                </div>
            </div>
            
            <div class="legend-section">
                <div class="legend-section-title">
                    Stress Levels
                    <div class="legend-toggle">
                        <input type="checkbox" id="toggle-stress" checked>
                    </div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(73,242,252,1.0);"></div>
                    <div class="legend-label">High Stress (0.635 - 0.729)</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(85,136,230,1.0);"></div>
                    <div class="legend-label">Medium Stress (0.729 - 0.779)</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(9,4,129,1.0);"></div>
                    <div class="legend-label">Low Stress (0.779 - 0.808)</div>
                </div>
            </div>
            
            <div class="legend-section">
                <div class="legend-section-title">
                    Aerial Image
                    <div class="legend-toggle">
                        <input type="checkbox" id="toggle-image" checked>
                    </div>
                </div>
                <div class="legend-item">
                    <div class="legend-label">High-resolution orthophoto</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- External Data Files (You'll need to include these) -->
    <script src="data/MainHelthCategories_1.js"></script>
    <script src="data/Unhealthytrees_2.js"></script>
    
    <script>
        // Initialize map with dark theme
        var map = L.map('map', {
            zoomControl: true,
            maxZoom: 28,
            minZoom: 1
        });
        
        // Position zoom control
        map.zoomControl.setPosition('topleft');
        
        // Define base map layers
        var baseMaps = {
            dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }),
            streets: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri',
                maxZoom: 19
            }),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a>',
                maxZoom: 17
            })
        };
        
        // Add dark map as default
        var currentBaseMap = baseMaps.dark.addTo(map);
        
        // Base map selector functionality
        document.getElementById('basemap-select').addEventListener('change', function(e) {
            map.removeLayer(currentBaseMap);
            currentBaseMap = baseMaps[e.target.value].addTo(map);
            currentBaseMap.bringToBack();
            if (imageOverlay) imageOverlay.bringToFront();
        });
        
        // Create image overlay
        var imgBounds = [[7.317894799030001, 79.982185035245], [7.321191612635, 79.987791803725]];
        var imageOverlay = L.imageOverlay('images/makadura_u_0 (1).jpg', imgBounds).addTo(map);
        
        // Create feature groups for layers
        var healthLayer = L.featureGroup().addTo(map);
        var stressLayer = L.featureGroup().addTo(map);
        
        // Popup function
        function createPopup(feature) {
            var content = '<table style="width:100%">';
            content += '<tr><td><strong>ID:</strong></td><td>' + (feature.properties.Id || 'N/A') + '</td></tr>';
            content += '<tr><td><strong>State:</strong></td><td>' + (feature.properties.StateName || 'N/A') + '</td></tr>';
            content += '<tr><td><strong>Crop:</strong></td><td>' + (feature.properties.CroupName || 'N/A') + '</td></tr>';
            content += '<tr><td><strong>Height:</strong></td><td>' + (feature.properties.CroupHight || 'N/A') + '</td></tr>';
            content += '<tr><td><strong>Health:</strong></td><td>' + (feature.properties.Co_Health || 'N/A') + '</td></tr>';
            content += '<tr><td><strong>NDVI:</strong></td><td>' + (feature.properties.ZonalSt__1 ? feature.properties.ZonalSt__1.toFixed(3) : 'N/A') + '</td></tr>';
            content += '<tr><td><strong>Age:</strong></td><td>' + (feature.properties.Age || 'N/A') + '</td></tr>';
            content += '<tr><td><strong>Disease:</strong></td><td>' + (feature.properties.Disease || 'N/A') + '</td></tr>';
            content += '</table>';
            return content;
        }
        
        // Style function for health categories
        function styleHealth(feature) {
            var value = feature.properties.ZonalSt__1;
            var fillColor, radius = 6;
            
            if (value >= 0.635448 && value <= 0.808004) {
                fillColor = 'rgba(254,47,47,1.0)'; // Unhealthy - Red
            } else if (value > 0.808004 && value <= 0.854374) {
                fillColor = 'rgba(255,187,0,1.0)'; // Moderate - Yellow
            } else if (value > 0.854374 && value <= 0.913540) {
                fillColor = 'rgba(6,92,0,1.0)'; // Healthy - Green
            } else {
                fillColor = 'rgba(128,128,128,0.5)';
            }
            
            return {
                radius: radius,
                fillColor: fillColor,
                color: 'rgba(255,255,255,0.8)',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            };
        }
        
        // Style function for stress levels
        function styleStress(feature) {
            var value = feature.properties.ZonalSt__1;
            var fillColor, radius = 6;
            
            if (value >= 0.635448 && value <= 0.728672) {
                fillColor = 'rgba(73,242,252,1.0)'; // High Stress - Cyan
            } else if (value > 0.728672 && value <= 0.778739) {
                fillColor = 'rgba(85,136,230,1.0)'; // Medium Stress - Blue
            } else if (value > 0.778739 && value <= 0.808004) {
                fillColor = 'rgba(9,4,129,1.0)'; // Low Stress - Dark Blue
            } else {
                fillColor = 'rgba(128,128,128,0.5)';
            }
            
            return {
                radius: radius,
                fillColor: fillColor,
                color: 'rgba(255,255,255,0.8)',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            };
        }
        
        // Add health categories layer
        if (typeof json_MainHelthCategories_1 !== 'undefined') {
            L.geoJSON(json_MainHelthCategories_1, {
                pointToLayer: function(feature, latlng) {
                    return L.circleMarker(latlng, styleHealth(feature));
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature));
                }
            }).addTo(healthLayer);
        }
        
        // Add stress levels layer
        if (typeof json_Unhealthytrees_2 !== 'undefined') {
            L.geoJSON(json_Unhealthytrees_2, {
                pointToLayer: function(feature, latlng) {
                    return L.circleMarker(latlng, styleStress(feature));
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createPopup(feature));
                }
            }).addTo(stressLayer);
        }
        
        // Layer toggle functionality
        document.getElementById('toggle-health').addEventListener('change', function(e) {
            if (e.target.checked) {
                map.addLayer(healthLayer);
            } else {
                map.removeLayer(healthLayer);
            }
        });
        
        document.getElementById('toggle-stress').addEventListener('change', function(e) {
            if (e.target.checked) {
                map.addLayer(stressLayer);
            } else {
                map.removeLayer(stressLayer);
            }
        });
        
        document.getElementById('toggle-image').addEventListener('change', function(e) {
            if (e.target.checked) {
                map.addLayer(imageOverlay);
            } else {
                map.removeLayer(imageOverlay);
            }
        });
        
        // Set initial view to the image bounds
        map.fitBounds(imgBounds);
        
        // Ensure proper layer ordering
        setTimeout(function() {
            currentBaseMap.bringToBack();
            if (imageOverlay) imageOverlay.bringToFront();
            healthLayer.bringToFront();
            stressLayer.bringToFront();
        }, 100);
    </script>
</body>
</html>